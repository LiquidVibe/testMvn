node("docker") {
    stage('SCM Checkout'){
        def mvnHome = tool name: 'TestMaven', type: 'maven'
        git 'https://github.com/LiquidVibe/testMvn'
    }

    docker.withRegistry('<<your-docker-registry>>', '<<your-docker-registry-credentials-id>>') {

        git url: "<<your-git-repo-url>>", credentialsId: '<<your-git-credentials-id>>'

        sh "git rev-parse HEAD > .git/commit-id"
        def commit_id = readFile('.git/commit-id').trim()
        println commit_id

        stage "build"
        def app = docker.build "your-project-name"

        stage "publish"
        app.push 'master'
        app.push "${commit_id}"
    }
}


          stage ('run docker') {
            steps{
                sh 'docker run -v /var/run/docker.sock:/var/run/docker.sock ubuntu:latest'
                sh 'apt-get update'
             }
          }

          sudo usermod -a -G root jenkins
          sudo service jenkins restart


          or

          sudo usermod -a -G docker jenkins

RUN apt-get update && apt-get install -y apt-transport-https


          RUN apt-get update \
                && apt-get install -y sudo \
                && rm -rf /var/lib/apt/lists/*
          RUN echo "jenkins ALL=NOPASSWD: ALL" >> /etc/sudoers


          sh "docker network create ${network}"
                          sh "docker run -d -p 4444:4444 --name ${seleniumHub} --network ${network} selenium/hub"
                          sh "docker run -d -e HUB_PORT_4444_TCP_ADDR=${seleniumHub} -e HUB_PORT_4444_TCP_PORT=4444 --network ${network} --name ${chrome} selenium/node-chrome"

    post {
        always {
            sh 'docker-compose -f ./docker-compose rm -f -s'
            sh 'docker-compose -f ./docker-compose.yml down --rmi local --remove-orphans'
        }
    }


RUN docker pull selenium/hub
RUN docker pull selenium/node-chrome-debug
RUN docker run -d -p 4444:4444 --name selenium-hub -P selenium/hub
RUN docker run -d -P --name chrome --link selenium-hub:hub selenium/node-chrome-debug

    compile:
       dockerfile: .dockerfile
       project_name: dockerMvnRepo
    services:
      mysql:
        image: mysql:5.7
        environment:
        - MYSQL_ROOT_PASSWORD=password
        - MYSQL_DATABASE=admin
        networks:
        - compose-net
        expose:
        - 3306

      java-unit:
        image: java:11-jdk
        working_dir: /src


RUN curl -L "https://github.com/docker/compose/releases/download/1.22.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
RUN chmod +x /usr/local/bin/docker-compose
RUN docker-compose --version
RUN cd /dockerMvnRepo/
RUN docker-compose up
